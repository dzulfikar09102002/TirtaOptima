@model TirtaOptima.ViewModels.DebtMonitoringsViewModel
@using System.Globalization
@{
    int no = 1;
}
<div class="card mt-2">
    <div class="card-body">
        <table id="tbl" class="table table-hover table-striped align-middle table-bordered">
            <thead class="table-light">
                <tr>
                    <th rowspan="2" class="text-center align-middle">No.</th>
                    <th rowspan="2" class="text-center align-middle">Pelanggan</th>
                    <th rowspan="2" class="text-center align-middle">Nomor & Jenis</th>
                    <th rowspan="2" class="text-center align-middle">Alamat</th>
                    <th rowspan="2" class="text-center align-middle">Nominal</th>
                    <th rowspan="2" class="text-center align-middle">Tunggakan</th>
                    <th rowspan="2" class="text-center align-middle">Status</th>
                    <th colspan="@Model.Policies.Count" class="text-center">Rekomendasi Tindakan</th>
                </tr>
                <tr>
                    @foreach (var item in Model.Policies.OrderBy(x => x.RentangWaktu))
                    {
                        <th class="text-center">
                            @item.NamaStrategi
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Debts)
                {
                    <tr class="odd">
                        <td class="text-center">@no</td>
                        <td class="text-center">
                            <strong>@item.PelangganId</strong> <br />
                            @item.Pelanggan.Nama
                        </td>
                        <td class="text-center">
                            <span class="fw-bold">@(item.Pelanggan.Nomor ?? "-")</span> <br /> @item.Pelanggan.JenisNavigation!.Deskripsi
                        </td>
                        <td class="text-center">
                            @item.Pelanggan.Alamat <br />
                            @item.Pelanggan.KelurahanNavigation!.Nama | @item.Pelanggan.KelurahanNavigation.KodeKecNavigation!.Nama
                        </td>

                        <td class="text-end">
                            <strong>
                                @(
                                    string.Format(
                                    new System.Globalization.CultureInfo("id-ID"),
                                    "Rp {0:N0}",
                                    Math.Abs(item.Nominal)
                                    )
                                    )
                            </strong>
                            <br />
                            <span class="badge badge-label bg-@(item.Nominal == 0 ? "success" : item.Nominal > 1 ? "danger" : "info")">
                                <i class="mdi mdi-circle-medium"></i>
                                @(item.Nominal == 0 ? "Lunas" : item.Nominal > 1 ? "Belum Lunas" : "Lebih Bayar")
                            </span>
                        </td>
                        <td class="text-center">
                            @item.TanggalTerakhir!.Value.ToString("d MMMM yyyy", new System.Globalization.CultureInfo("id-ID"))
                            <br />
                            <span class="badge bg-@(item.Nominal == 0 ? "success" : item.Nominal > 1 ? "danger" : "info")">
                                + @((item.TanggalTerakhir.HasValue
                                  ? (DateTime.Now - item.TanggalTerakhir.Value).Days.ToString() + " Hari"
                                  : "Tanggal belum tersedia"))
                            </span>
                        </td>
                        <td class="text-center">
                            @(item.Nominal != 0 ? (item.Collections != null && item.Collections.Any() ? item.Collections.LastOrDefault()?.StatusId : "-") : "Tuntas")
                        </td>
                        @foreach (var policy in Model.Policies)
                        {
                            <td class="text-center">
                                @Html.Raw(item.TanggalTerakhir.HasValue && (DateTime.Now - item.TanggalTerakhir.Value).Days < policy.RentangWaktu
                                         ? "<img src='/assets/images/close.png' class='mb-2' />"
                                         : "<img src='/assets/images/check.png' class='mb-2' />")
                            </td>
                        }
                    </tr>
                    no++;
                }
            </tbody>
        </table>
    </div>
</div>
<div id="period-container"
     data-bulan="@Model.BulanSelect"
     data-tahun="@Model.TahunSelect">
    @{
        TempData["Bulan-mp"] = Model.BulanSelect;
        TempData["Tahun-mp"] = Model.TahunSelect;
        if (!string.IsNullOrEmpty(ViewBag.Message))
        {
            <div id="partial-message" data-message="@ViewBag.Message"></div>
        }
    }
</div>
<script>

    $(document).ready(function () {
        $('#tbl').DataTable({
        })
    });
</script>

